---
title: "Analysing Helipad Data"
author: "Danny Wong"
date: "Sunday, April 05, 2015"
output: html_document
---

We have some data from the KSS HEMS patients conveyed to KCH.

```{r}
#Read the data into a dataframe, specify the NA strings to incorporate the missing values
data <- read.csv("data/HEMSdata.csv", na.strings=c("NA","n/a", ""))

#Let's look at the table
View(data)

#Let's see how many cases there are
print(nrow(data))
```

Notice that the coordinates are in the Ordnance Survey Grid format under the column "Grid". For us to work with this meaningfully, we need to convert this to latitude and longitude (WGS84) coordinates.

Fortunately there are others who have encountered the same problem before:

Sources: 

    * http://stackoverflow.com/questions/23017053/how-to-convert-uk-grid-reference-to-latitude-and-longitude-in-r
    * https://stat.ethz.ch/pipermail/r-sig-geo/2010-November/010141.html
    * http://www.hannahfry.co.uk/blog/2012/02/01/converting-british-national-grid-to-latitude-and-longitude-ii
    * http://cran.r-project.org/web/packages/rnrfa/rnrfa.pdf

```{r}
#Load the required packages
require(rnrfa)
require(dplyr)

#Remove the rows with missing Grid references
data <- filter(data, !is.na(Grid))
  
#Parse the OS Grid References into Eastings and Northings, then pipe it into WSG84 Coordinates
coordinates <- OSGParse(data$Grid) %>% OSG2LatLon()

#Add these onto the data
data <- mutate(data, lat = coordinates$Latitude, lon = coordinates$Longitude)

#Write to .csv
write.csv(data, file="data/cleaned.csv")
```

We can now start making some maps!

Let's first visualise the locations of each HEMS pickup as a quick visualisation

```{r}
#Load the required libraries
require(ggplot2)
require(ggmap)

#Load the data
data <- read.csv("data/cleaned.csv")

#Get map from Google
ukmap <- get_map(location = "London, UK", zoom = 8, scale = 4)
ggmap(ukmap) + geom_point(data = data, aes(x = data$lon, y = data$lat, fill = "red", alpha = 0.8), size = 4, shape = 21) + guides(fill=FALSE, alpha=FALSE, size=FALSE)

#We can separate the cases by the county where they come from, let's see the counties where they come from
tally(group_by(data, County))

```

We want to see whether there is a temporal relationship between the HEMS cases and 

```{r}
#Load the required libraries
require(lubridate)
require(dplyr)

#We need to format the date fields in a way that R can process it
timestamp <- paste(data$Date, " ", data$Time)

data$Date <- dmy(data$Date)

#Let's see if there is a difference between the cases depending of which day of the week they arrive
tally(group_by(data, Day))

```

